#!/usr/bin/with-contenv bashio
set -euo pipefail

mkdir -p /run/openwisp /data /data/static /data/media /data/private /data/logs /data/ssh
mkdir -p /opt/openwisp/public

ln -sfn /data/static /opt/openwisp/static
ln -sfn /data/media /opt/openwisp/media
ln -sfn /data/private /opt/openwisp/private
ln -sfn /data/logs /opt/openwisp/logs
ln -sfn /opt/openwisp/static /opt/openwisp/public/static
ln -sfn /opt/openwisp/media /opt/openwisp/public/media

get_config() {
  local key="$1"
  bashio::config "$key"
}

has_config() {
  local key="$1"
  bashio::config.has_value "$key"
}

get_config_default() {
  local key="$1"
  local default_value="$2"
  if has_config "$key"; then
    get_config "$key"
  else
    echo "$default_value"
  fi
}

if ! has_config 'db_host'; then
  bashio::log.error "db_host is required."
  exit 1
fi

if ! has_config 'redis_host'; then
  bashio::log.error "redis_host is required."
  exit 1
fi

ADMIN_EMAIL=$(get_config 'admin_email')
ADMIN_PASSWORD=$(get_config 'admin_password')
TIME_ZONE="$(bashio::info.timezone || true)"
if [ -z "${TIME_ZONE}" ]; then
  TIME_ZONE="UTC"
fi
LANGUAGE_CODE="$(bashio::core 'core.info.language' '.language' || true)"
if [ -z "${LANGUAGE_CODE}" ] || [ "${LANGUAGE_CODE}" = "null" ]; then
  LANGUAGE_CODE="en-gb"
fi
DEBUG=$(get_config 'debug')
ALLOWED_HOSTS=$(get_config_default 'host_allowlist' '*')
DOMAIN=$(get_config_default 'public_domain' 'localhost')
API_DOMAIN=$(get_config_default 'api_domain' '')
if [ -z "${API_DOMAIN}" ]; then
  API_DOMAIN="api.${DOMAIN}"
fi
CORS_HOSTS=$(get_config_default 'cors_allowlist' '*')

DB_ENGINE=$(get_config_default 'db_engine' 'django.contrib.gis.db.backends.postgis')
DB_HOST=$(get_config 'db_host')
DB_PORT=$(get_config 'db_port')
DB_NAME=$(get_config 'db_name')
DB_USER=$(get_config 'db_user')
DB_PASSWORD=$(get_config 'db_password')

REDIS_HOST=$(get_config 'redis_host')
REDIS_PORT=$(get_config 'redis_port')
REDIS_USER=$(get_config_default 'redis_user' '')
REDIS_PASSWORD=$(get_config_default 'redis_password' '')

USE_RADIUS=$(get_config_default 'use_radius' 'false')
USE_TOPOLOGY=$(get_config_default 'use_topology' 'false')
USE_FIRMWARE=$(get_config_default 'use_firmware' 'false')
USE_MONITORING=$(get_config_default 'use_monitoring' 'false')
METRIC_COLLECTION=$(get_config_default 'metric_collection' 'false')
FREERADIUS_ALLOWED_HOSTS=$(get_config_default 'freeradius_allowed_hosts' '127.0.0.1/32')

INFLUXDB_USER=$(get_config_default 'influxdb_user' 'admin')
INFLUXDB_PASS=$(get_config_default 'influxdb_pass' 'admin')
INFLUXDB_NAME=$(get_config_default 'influxdb_name' 'openwisp')
INFLUXDB_HOST=$(get_config_default 'influxdb_host' '')
INFLUXDB_PORT=$(get_config_default 'influxdb_port' '8086')
INFLUXDB_DEFAULT_RETENTION_POLICY=$(get_config_default 'influxdb_retention_policy' '26280h0m0s')

metric_lower=$(echo "${METRIC_COLLECTION}" | tr '[:upper:]' '[:lower:]')
if [ "${metric_lower}" = "true" ] && [ -z "${INFLUXDB_HOST}" ]; then
  bashio::log.error "metric_collection requires influxdb_host to be set."
  exit 1
fi

SECRET_KEY=$(get_config_default 'secret_key' '')
if [ -z "$SECRET_KEY" ]; then
  if [ -f /data/secret_key ]; then
    SECRET_KEY=$(cat /data/secret_key)
  else
    SECRET_KEY=$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c 64)
    printf "%s" "$SECRET_KEY" > /data/secret_key
    chmod 600 /data/secret_key || true
  fi
fi

DOLLAR='$'

REDIS_CREDENTIALS=""
if [ -n "${REDIS_USER}" ] && [ -n "${REDIS_PASSWORD}" ]; then
  REDIS_CREDENTIALS="${REDIS_USER}:${REDIS_PASSWORD}@"
elif [ -n "${REDIS_PASSWORD}" ]; then
  REDIS_CREDENTIALS=":${REDIS_PASSWORD}@"
fi
REDIS_BASE_URL="redis://${REDIS_CREDENTIALS}${REDIS_HOST}:${REDIS_PORT}"

cat <<ENV > /run/openwisp/env
export ADMIN_EMAIL="${ADMIN_EMAIL}"
export ADMIN_PASSWORD="${ADMIN_PASSWORD}"
export TZ="${TIME_ZONE}"
export DJANGO_LANGUAGE_CODE="${LANGUAGE_CODE}"
export DEBUG_MODE="${DEBUG}"
export DJANGO_ALLOWED_HOSTS="${ALLOWED_HOSTS}"
export DASHBOARD_DOMAIN="${DOMAIN}"
export API_DOMAIN="${API_DOMAIN}"
export MODULE_NAME="dashboard"

export DB_ENGINE="${DB_ENGINE}"
export DB_NAME="${DB_NAME}"
export DB_USER="${DB_USER}"
export DB_PASS="${DB_PASSWORD}"
export DB_HOST="${DB_HOST}"
export DB_PORT="${DB_PORT}"
export DB_SSLMODE="disable"
export DB_SSLKEY="None"
export DB_SSLCERT="None"
export DB_SSLROOTCERT="None"
export DB_OPTIONS="{}"

export REDIS_HOST="${REDIS_HOST}"
export REDIS_PORT="${REDIS_PORT}"
export REDIS_USER="${REDIS_USER}"
export REDIS_PASS="${REDIS_PASSWORD}"
export REDIS_USE_TLS="False"
export REDIS_CACHE_URL="${REDIS_BASE_URL}/0"
export CHANNEL_REDIS_URL="${REDIS_BASE_URL}/1"
export CELERY_BROKER_URL="${REDIS_BASE_URL}/2"

export DJANGO_SECRET_KEY="${SECRET_KEY}"
export DJANGO_LOG_LEVEL="INFO"
if [ "${CORS_HOSTS}" = "*" ]; then
  export DJANGO_CORS_ALLOW_ALL_ORIGINS="True"
  export DJANGO_CORS_HOSTS=""
else
  export DJANGO_CORS_ALLOW_ALL_ORIGINS="False"
  export DJANGO_CORS_HOSTS="${CORS_HOSTS}"
fi
export DJANGO_SENTRY_DSN=""
export DJANGO_LEAFET_CENTER_X_AXIS="0"
export DJANGO_LEAFET_CENTER_Y_AXIS="0"
export DJANGO_LEAFET_ZOOM="1"
export DJANGO_X509_DEFAULT_CERT_VALIDITY="1825"
export DJANGO_X509_DEFAULT_CA_VALIDITY="3650"
export OPENWISP_RADIUS_FREERADIUS_ALLOWED_HOSTS="${FREERADIUS_ALLOWED_HOSTS}"
export X509_NAME_CA="default"
export X509_NAME_CERT="default"
export X509_COUNTRY_CODE="IN"
export X509_STATE="Delhi"
export X509_CITY="New Delhi"
export X509_ORGANIZATION_NAME="OpenWISP"
export X509_ORGANIZATION_UNIT_NAME="OpenWISP"
export X509_EMAIL="${ADMIN_EMAIL}"
export X509_COMMON_NAME="OpenWISP"
export VPN_DOMAIN="openvpn.example.com"
export VPN_NAME="default"
export VPN_CLIENT_NAME="default-management-vpn"

export EMAIL_BACKEND="django.core.mail.backends.console.EmailBackend"
export EMAIL_HOST="localhost"
export EMAIL_HOST_PORT="25"
export EMAIL_HOST_USER=""
export EMAIL_HOST_PASSWORD=""
export EMAIL_HOST_TLS="False"
export EMAIL_TIMEOUT="10"
export EMAIL_DJANGO_DEFAULT="${ADMIN_EMAIL}"

export SSH_PRIVATE_KEY_PATH="/data/ssh/id_ed25519"
export SSH_PUBLIC_KEY_PATH="/data/ssh/id_ed25519.pub"

export INFLUXDB_USER="${INFLUXDB_USER}"
export INFLUXDB_PASS="${INFLUXDB_PASS}"
export INFLUXDB_NAME="${INFLUXDB_NAME}"
export INFLUXDB_HOST="${INFLUXDB_HOST}"
export INFLUXDB_PORT="${INFLUXDB_PORT}"
export INFLUXDB_DEFAULT_RETENTION_POLICY="${INFLUXDB_DEFAULT_RETENTION_POLICY}"

export SSL_CERT_MODE="False"
export NGINX_PORT="80"
export NGINX_SSL_PORT="443"
export NGINX_CLIENT_BODY_SIZE="30"
export NGINX_HTTP_ALLOW="True"
export NGINX_HTTPS_ALLOWED_IPS="all"
export NGINX_GZIP_SWITCH="on"
export NGINX_GZIP_LEVEL="6"
export NGINX_GZIP_PROXIED="any"
export NGINX_GZIP_MIN_LENGTH="1000"
export NGINX_GZIP_TYPES="text/plain image/svg+xml application/json application/javascript text/xml text/css application/xml application/x-font-ttf font/opentype"
export NGINX_CUSTOM_FILE="False"
export NGINX_IP6_STRING=""
export NGINX_IP6_80_STRING=""
export NGINX_80_CONFIG=""
export NGINX_SSL_CONFIG=""
export NGINX_SERVER_NAME_HASH_BUCKET="32"
export NINGX_REAL_REMOTE_ADDR='${DOLLAR}real_ip'
export DOLLAR='${DOLLAR}'

export DASHBOARD_APP_SERVICE="127.0.0.1"
export API_APP_SERVICE="127.0.0.1"
export WEBSOCKET_APP_SERVICE="127.0.0.1"
export DASHBOARD_APP_PORT="8000"
export API_APP_PORT="8001"
export WEBSOCKET_APP_PORT="8002"
export DASHBOARD_INTERNAL="localhost"
export API_INTERNAL="localhost"

export USE_OPENWISP_RADIUS="${USE_RADIUS}"
export USE_OPENWISP_TOPOLOGY="${USE_TOPOLOGY}"
export USE_OPENWISP_FIRMWARE="${USE_FIRMWARE}"
export USE_OPENWISP_MONITORING="${USE_MONITORING}"
export USE_OPENWISP_CELERY_TASK_ROUTES_DEFAULTS="True"
export USE_OPENWISP_CELERY_NETWORK="False"
export USE_OPENWISP_CELERY_MONITORING="False"
export USE_OPENWISP_CELERY_MONITORING_CHECKS="False"
export USE_OPENWISP_CELERY_FIRMWARE="False"
export METRIC_COLLECTION="${METRIC_COLLECTION}"

export UWSGI_PROCESSES="2"
export UWSGI_THREADS="2"
export UWSGI_LISTEN="128"
export CONTAINER_PORT="8000"

export DJANGO_SETTINGS_MODULE="openwisp.settings_dashboard"
export PYTHONPATH="/opt/openwisp"
ENV
